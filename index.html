<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SVR Search</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.search-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 15px;
}

th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }

thead th {
  position: sticky;
  top: 0;
  background: #f3f3f3;
}

/* Loader & modal same as home */
.loader-overlay, .modal-overlay { position: fixed; inset:0; display:none; align-items:center; justify-content:center; }
.loader-overlay { background:rgba(255,255,255,.8); z-index:9999; }
.modal-overlay { background:rgba(0,0,0,.4); z-index:10000; }

.spinner {
  width:48px;height:48px;border:5px solid #ccc;border-top-color:#333;
  border-radius:50%;animation:spin 1s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

.modal-box { background:#fff;padding:20px;border-radius:6px;min-width:260px;text-align:center; }
</style>
</head>

<body>

<div id="loader" class="loader-overlay"><div class="spinner"></div></div>

<div id="modal" class="modal-overlay">
  <div class="modal-box">
    <div id="modal-text"></div><br>
    <button onclick="confirmYes()">Yes</button>
    <button onclick="closeModal()">No</button>
  </div>
</div>

<div class="top-bar">
  <button onclick="goBack()">‚Üê Back</button>
  <strong id="listTitle"></strong>
  <button onclick="closeList()">Close List</button>
</div>

<div class="search-row">
  <label>From</label><input type="date" id="from">
  <label>To</label><input type="date" id="to">
  <label>Machine</label><input type="text" id="machine">
  <button onclick="search()">Search</button>
</div>

<table id="table">
<thead>
<tr>
<th>Select</th><th>Date</th><th>Location</th><th>Engineer</th>
<th>WS/OS</th><th>Call Type</th><th>Complaint</th><th>Customer</th>
<th>Machine</th><th>HMR</th><th>Status</th><th>Site</th>
<th>Call ID</th><th>Labour</th><th>Distance</th><th>TA+DA</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const params=new URLSearchParams(location.search);
let LIST_ID=params.get("listId")||sessionStorage.getItem("ACTIVE_LIST_ID");
if(!LIST_ID) location.href="home.html";

sessionStorage.setItem("ACTIVE_LIST_ID",LIST_ID);
document.getElementById("listTitle").innerText="Working on List : "+LIST_ID;

from.value="2025-12-01";
to.value=new Date().toISOString().split("T")[0];

function search(){
  const m=machine.value.trim();
  if(!m) return showModal("Please enter Machine Number");

  showLoader(true);

  const cb="s_"+Date.now();let s;
  window[cb]=d=>{render(d.rows||[]);showLoader(false);cleanup();};
  function cleanup(){delete window[cb];s.remove();}

  s=document.createElement("script");
  s.src=`${API_URL}?action=search&machine=${m}&from=${from.value}&to=${to.value}&callback=${cb}`;
  document.body.appendChild(s);
}

function render(rows){
  const tb=document.querySelector("#table tbody");
  tb.innerHTML="";
  if(!rows.length) return tb.innerHTML="<tr><td colspan='16'>No records</td></tr>";

  rows.forEach(r=>{
    tb.innerHTML+=`
<tr>
<td><input type="checkbox" onchange="saveRow(this,${encodeURIComponent(JSON.stringify(r))})"></td>
<td>${fmt(r[26])}</td><td>${r[0]}</td><td>${r[1]}</td>
<td>${r[2]}</td><td>${r[3]}</td><td>${r[5]}</td><td>${r[6]}</td>
<td>${r[8]}</td><td>${r[9]}</td><td>${r[10]}</td><td>${r[14]}</td>
<td>${r[19]}</td><td>${r[20]}</td><td>${r[21]}</td><td>${r[25]}</td>
</tr>`;
  });
}

function saveRow(cb,row){
  if(!cb.checked) return;
  const svr=prompt("Enter SVR Number");
  if(!svr){cb.checked=false;return;}

  const s=document.createElement("script");
  s.src=`${API_URL}?action=saveRow&listId=${LIST_ID}&svrNo=${svr}&row=${row}&callback=x`;
  document.body.appendChild(s);
}

let confirmAction=null;
function goBack(){confirmAction=()=>location.href="home.html";showModal("Close list and go home?");}
function closeList(){confirmAction=()=>{sessionStorage.removeItem("ACTIVE_LIST_ID");location.href="home.html";};showModal("Close this list?");}
function confirmYes(){closeModal();if(confirmAction)confirmAction();}

function showLoader(s){loader.style.display=s?"flex":"none";}
function showModal(t){modalText.innerText=t;modal.style.display="flex";}
function closeModal(){modal.style.display="none";}
function fmt(v){const d=new Date(v);return isNaN(d)?"":d.toLocaleDateString("en-GB");}
</script>

</body>
</html>
