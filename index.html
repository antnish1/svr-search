<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SVR Search</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.search-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 15px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  font-size: 12px;
}

thead th {
  position: sticky;
  top: 0;
  background: #f3f3f3;
}

/* Loader */
.loader-overlay {
  position: fixed;
  inset: 0;
  display: none;              /* ‚úÖ JS controls loader */
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,.8);
  z-index: 9999;
}

/* Modal */

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.4);
  z-index: 10000;

  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.modal-overlay.show {
  opacity: 1;
  pointer-events: auto;
}




.loader-overlay {
  background: rgba(255,255,255,.8);
  z-index: 9999;
}



.spinner {
  width: 48px;
  height: 48px;
  border: 5px solid #ccc;
  border-top-color: #333;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.modal-box {
  background: #fff;
  padding: 20px;
  border-radius: 6px;
  min-width: 260px;
  text-align: center;
}






  
</style>
</head>

<body>

<!-- Loader -->
<div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>

<!-- Confirm / Alert Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-box">
    <div id="modal-text"></div><br>
    <button onclick="confirmYes()">Yes</button>
    <button onclick="closeModal()">No</button>
  </div>
</div>

<!-- SVR INPUT MODAL (‚úÖ CORRECT PLACE) -->
<!-- SVR INPUT MODAL -->
<div id="svrModal" class="modal-overlay">
  <div class="modal-box">
    <div style="margin-bottom:10px;font-weight:bold">
      Enter SVR Number
    </div>

    <input
      type="text"
      id="svrInput"
      style="width:100%;padding:6px"
    >

    <!-- üî¥ ERROR MESSAGE -->
    <div
      id="svrError"
      style="color:red;font-size:12px;margin-top:6px;display:none"
    >
      SVR Number is mandatory
    </div>

    <div style="margin-top:15px">
      <button id="svrSaveBtn" onclick="saveSVR()">Save</button>

      <button onclick="closeSVRModal()">Cancel</button>
    </div>
  </div>
</div>


<div class="top-bar">
  <button onclick="goBack()">‚Üê Back</button>
  <strong id="listTitle"></strong>
  <button onclick="closeList()">Close List</button>
</div>

<div class="search-row">
  <label>From</label><input type="date" id="from">
  <label>To</label><input type="date" id="to">
  <label>Machine</label><input type="text" id="machine">
  <button onclick="search()">Search</button>
</div>

<table id="table">
<thead>
<tr>
  <th>Select</th>
  <th>Edit</th>
  <th>Date</th>
  <th>Location</th>
  <th>Engineer</th>
  <th>WS/OS</th>
  <th>Call Type</th>
  <th>Complaint</th>
  <th>Customer</th>
  <th>Machine</th>
  <th>HMR</th>
  <th>Status</th>
  <th>Site</th>
  <th>Call ID</th>
  <th>Labour</th>
  <th>Distance</th>
  <th>TA+DA</th>
</tr>

</thead>
<tbody></tbody>
</table>

<script>
let pendingRow = null;
let pendingCheckbox = null;
let processedKeys = {};

const loader = document.getElementById("loader"); 
const modal = document.getElementById("modal");
const modalText = document.getElementById("modal-text");
const svrModal = document.getElementById("svrModal");
const svrInput = document.getElementById("svrInput");
const svrError = document.getElementById("svrError");


  
const API_URL =
"https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const params = new URLSearchParams(location.search);
let LIST_ID = params.get("listId") || sessionStorage.getItem("ACTIVE_LIST_ID");
if (!LIST_ID) location.href = "home.html";

sessionStorage.setItem("ACTIVE_LIST_ID", LIST_ID);
listTitle.innerText = "Working on List : " + LIST_ID;

from.value = "2025-12-01";
to.value = new Date().toISOString().split("T")[0];

function td(content) {
  const c = document.createElement("td");
  if (content instanceof HTMLElement) c.appendChild(content);
  else c.textContent = content ?? "";
  return c;
}
function textCell(value) {
  const span = document.createElement("span");
  span.textContent = value ?? "";
  return span;
}

function inputCell(value) {
  const input = document.createElement("input");
  input.type = "text";
  input.value = value ?? "";
  input.style.width = "90%";
  return input;
}

  
function search() {
  const m = machine.value.trim();
   if (!m) {
    showConfirm("Please enter Machine Number", () => {});
    return;
  }


  showLoader(true);

  const cb = "s_" + Date.now();
  let s;

  window[cb] = d => {
    processedKeys = d.processedKeys || {};
    render(d.rows || []);
    if (d.listStatus === "VERIFIED") {
      lockVerifiedListUI();
    }
    showLoader(false);
    delete window[cb];
    s.remove();
  };

  s = document.createElement("script");
  s.src = `${API_URL}?action=search&machine=${m}&from=${from.value}&to=${to.value}&callback=${cb}`;
  document.body.appendChild(s);
}



function lockVerifiedListUI() {
  // Disable selection & editing
  document.querySelectorAll("input, button").forEach(el => {
    el.disabled = true;
  });

  // Optional: show message
  showConfirm("This list is VERIFIED and locked.", () => {});
}


  
function getLocalDateKey(value) {
  const d = new Date(value);
  if (isNaN(d)) return "";

  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");

  return `${y}-${m}-${day}`;
}

  
  
function render(rows) {
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  if (!rows.length) {
    tbody.innerHTML =
      "<tr><td colspan='17'>No records found</td></tr>";
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");

    /* ===== DUPLICATE / PROCESSED CHECK ===== */
    const dateKey = getLocalDateKey(r[26]);
    const engineer = String(r[1] || "")
      .trim()
      .toUpperCase();

    const machine = String(r[8] || "")
      .replace(/\.0$/, "")
      .trim();

    const key = `${dateKey}|${engineer}|${machine}`;
    const isProcessed = processedKeys[key] === true;

    console.log("CHECK KEY:", key, processedKeys[key]);

    /* ===== SELECT CHECKBOX ===== */
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.disabled = isProcessed;

    if (!isProcessed) {
      cb.onclick = () => openSVRModal(cb, r);
    }

    /* ===== EDIT BUTTON ===== */
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.disabled = isProcessed;
    editBtn.onclick = () => enableEdit(tr, r);

    /* ===== BUILD ROW ===== */
    tr.appendChild(td(cb));          // Select
    tr.appendChild(td(editBtn));     // Edit

    tr.appendChild(td(fmt(r[26])));  // Date
    tr.appendChild(td(r[0]));        // Location
    tr.appendChild(td(r[1]));        // Engineer
    tr.appendChild(td(r[2]));        // WS/OS
    tr.appendChild(td(r[3]));        // Call Type
    tr.appendChild(td(r[5]));        // Complaint
    tr.appendChild(td(r[6]));        // Customer
    tr.appendChild(td(r[8]));        // Machine
    tr.appendChild(td(r[9]));        // HMR
    tr.appendChild(td(r[10]));       // Status

    // üîì Editable columns (read-only until Edit clicked)
    tr.appendChild(td(textCell(r[13]))); // Site
    tr.appendChild(td(textCell(r[19]))); // Call ID
    tr.appendChild(td(textCell(r[20]))); // Labour
    tr.appendChild(td(textCell(r[21]))); // Distance
    tr.appendChild(td(textCell(r[25]))); // TA+DA

    /* ===== PROCESSED UI ===== */
    if (isProcessed) {
      tr.style.backgroundColor = "#d9f7d9";
      tr.title = "Already processed";
    }

    tbody.appendChild(tr);
  });
}




function enableEdit(tr, rowData) {
  if (tr.dataset.editing === "1") return;
  if (pendingRow) return; // ‚ùå block edit if SVR modal active
  tr.dataset.editing = "1";

  const cells = tr.querySelectorAll("td");

  const editableMap = [
    { cell: 12, index: 13 }, // Site
    { cell: 13, index: 19 }, // Call ID
    { cell: 14, index: 20 }, // Labour
    { cell: 15, index: 21 }, // Distance
    { cell: 16, index: 25 }  // TA+DA
  ];

  editableMap.forEach(({ cell, index }) => {
    const input = document.createElement("input");
    input.type = "text";
    input.value = rowData[index] ?? "";
    input.style.width = "100%";

    input.oninput = () => {
      rowData[index] = input.value; // üî• live update
    };

    cells[cell].innerHTML = "";
    cells[cell].appendChild(input);
  });

  // Disable edit button after enabling edit
  const editTd = cells[1];
  editTd.innerHTML = "Editing‚Ä¶";
}



  
  

function openSVRModal(cb, rowData) {
  if (!cb.checked) return;

  pendingRow = rowData; // üî• SAME OBJECT that was edited
  pendingCheckbox = cb;

  pendingCheckbox._rowEl = cb.closest("tr");

  svrInput.value = "";
  svrError.style.display = "none";
  svrModal.classList.add("show");
}


  

function closeSVRModal() {
  
  svrModal.classList.remove("show");
  svrSaveBtn.disabled = false;

  if (pendingCheckbox && !pendingCheckbox.disabled) {
    pendingCheckbox.checked = false;
  }

  pendingRow = null;
  pendingCheckbox = null;
}



function saveSVR() {
  const svrNo = svrInput.value.trim();

  // üî¥ VALIDATION
  if (!svrNo) {
      svrError.style.display = "block";
      svrInput.focus();
      return;
    }
  
    svrError.style.display = "none";
  
    // ‚úÖ IMMEDIATELY LOCK UI

  
  svrError.style.display = "none";
  
  // ‚úÖ FADE OUT MODAL IMMEDIATELY
  svrModal.classList.remove("show");
  
  // ‚úÖ SHOW LOADER IMMEDIATELY
  showLoader(true);
  svrSaveBtn.disabled = true;


  const cb = "save_" + Date.now();
  let s;

  window[cb] = function () {
    // üîë Build processed key
    const dateKey = fmt(pendingRow[26]).split("/").reverse().join("-");
    const engineer = String(pendingRow[1]).trim();
    const machine = String(pendingRow[8]).trim();
    

    const key = `${dateKey}|${engineer}|${machine}`;
    processedKeys[key] = true;

    // ‚úÖ Update UI
    if (pendingCheckbox) {
      pendingCheckbox.disabled = true;
      pendingCheckbox.checked = true;
    }

    if (pendingCheckbox && pendingCheckbox._rowEl) {
      pendingCheckbox._rowEl.style.backgroundColor = "#d9f7d9";
      pendingCheckbox._rowEl.title = "Already processed";
    }


    // üîí LOCK EDITING
    const rowEl = pendingCheckbox._rowEl;
    const editBtn = rowEl.querySelector("td:nth-child(2) button");
    if (editBtn) {
      editBtn.disabled = true;
      editBtn.textContent = "Locked";
    }

    // ‚úÖ FINALIZE ROW UI (remove inputs, lock editing)
    if (pendingCheckbox && pendingCheckbox._rowEl) {
      finalizeRowUI(pendingCheckbox._rowEl, pendingRow);
    }


    // ‚úÖ CLEANUP
    showLoader(false);
    svrSaveBtn.disabled = false;
    

    delete window[cb];
    s.remove();
  };

  s = document.createElement("script");
  s.src =
    `${API_URL}?action=saveRow` +
    `&listId=${encodeURIComponent(LIST_ID)}` +
    `&svrNo=${encodeURIComponent(svrNo)}` +
    `&row=${encodeURIComponent(JSON.stringify(pendingRow))}` +
    `&callback=${cb}`;

  document.body.appendChild(s);
}




let confirmAction = null;

function showConfirm(message, onYes) {
  modalText.innerText = message;
  confirmAction = onYes;
  modal.classList.add("show");
}

function closeModal() {
  modal.classList.remove("show");
  confirmAction = null;
}

function confirmYes() {
  modal.classList.remove("show");

  if (confirmAction) {
    const action = confirmAction;
    confirmAction = null;
    action();
  }
}


/* ===== TOP BAR ACTIONS ===== */

function goBack() {
  showConfirm(
    "Are you sure you want to close this list?",
    () => location.href = "home.html"
  );
}

function closeList() {
  showConfirm(
    "Are you sure you want to close this list?",
    closeListConfirmed
  );
}

function closeListConfirmed() {
  showLoader(true);

  const cb = "close_" + Date.now();
  let s;

  window[cb] = () => {
    showLoader(false);
    sessionStorage.removeItem("ACTIVE_LIST_ID");
    location.href = "home.html";

    delete window[cb];
    s.remove();
  };

  s = document.createElement("script");
  s.src =
    `${API_URL}?action=closeList` +
    `&listId=${encodeURIComponent(LIST_ID)}` +
    `&callback=${cb}`;

  document.body.appendChild(s);
}

  
function showLoader(s) { loader.style.display = s ? "flex" : "none"; }


function fmt(v) { const d = new Date(v); return isNaN(d) ? "" : d.toLocaleDateString("en-GB"); }

// ‚úÖ Ensure clean UI on load
window.addEventListener("load", () => {
  showLoader(false);
  modal.classList.remove("show");
  svrModal.classList.remove("show");
});


function finalizeRowUI(tr, rowData) {
  const cells = tr.querySelectorAll("td");

  // Editable columns map
  const map = [
    { cell: 12, index: 13 }, // Site
    { cell: 13, index: 19 }, // Call ID
    { cell: 14, index: 20 }, // Labour
    { cell: 15, index: 21 }, // Distance
    { cell: 16, index: 25 }  // TA+DA
  ];

  map.forEach(({ cell, index }) => {
    cells[cell].innerHTML = "";
    cells[cell].textContent = rowData[index] ?? "";
  });

  // üîí Lock Edit column
  const editTd = cells[1];
  editTd.innerHTML = "Locked";
  editTd.style.color = "#888";
  editTd.style.fontWeight = "bold";

  // Clear editing state
  tr.dataset.editing = "0";
}



  
</script>

</body>
</html>























