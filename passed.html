<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mark Passed Amount</title>

<style>
:root {
  --primary:#1d4ed8; --bg:#eef2f7; --card:#fff; --border:#cbd5e1;
  --text:#111827; --muted:#6b7280; --danger:#b91c1c; --success:#15803d;
}
body{font-family:system-ui,Segoe UI,Arial;font-size:13px;background:var(--bg);padding:20px;color:var(--text)}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:var(--card);
  border:2px solid var(--border);border-radius:8px;padding:14px 18px;margin-bottom:16px}
h1{margin:0;font-size:18px}
.card{background:var(--card);border:2px solid var(--border);border-radius:8px;padding:16px}
table{width:100%;border-collapse:separate;border-spacing:0;border:2px solid var(--border);border-radius:8px;overflow:hidden}
th{background:#e2e8f0;padding:10px;font-size:12px}
td{padding:9px;border-bottom:1px solid var(--border);text-align:center}
tbody tr:nth-child(even){background:#f8fafc}
input[type=number]{width:110px;padding:6px;border:2px solid var(--border);border-radius:4px}
input[disabled]{background:#f3f4f6;color:#6b7280}
button{padding:7px 14px;border-radius:4px;border:none;font-weight:600;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca}
.loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);align-items:center;justify-content:center;z-index:9999}
.spinner{width:42px;height:42px;border:4px solid #cbd5e1;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="loader" class="loader"><div class="spinner"></div></div>

<div class="top-bar">
  <h1 id="title"></h1>
  <button class="btn-primary" onclick="goHome()">â¬… Back</button>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Engineer</th>
        <th>Machine No</th>
        <th>TA+DA</th>
        <th>Passed Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";
const LIST_ID = new URLSearchParams(location.search).get("listId");

document.getElementById("title").textContent = "Mark Passed : " + LIST_ID;

showLoader(true);
loadRows();

function showLoader(s){document.getElementById("loader").style.display=s?"flex":"none";}

function loadRows(){
  const cb="rows_"+Date.now(); let s;
  window[cb]=items=>{
    render(items); showLoader(false);
    delete window[cb]; s.remove();
  };
  s=document.createElement("script");
  s.src=`${API_URL}?action=getListRows&listId=${LIST_ID}&callback=${cb}`;
  document.body.appendChild(s);
}

function render(items){
  const tb=document.getElementById("tbody"); tb.innerHTML="";
  if(!items.length){tb.innerHTML="<tr><td colspan='6'>No rows</td></tr>";return;}

  items.forEach(o=>{
    const r=o.row;
    const passed=r[31]; // AF
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${fmt(r[28])}</td>
      <td>${r[3]}</td>
      <td>${r[10]}</td>
      <td>${r[27]}</td>
      <td>
        <input type="number" min="0" step="0.01"
          value="${passed||""}" ${passed?"disabled":""} id="p_${o.index}">
      </td>
      <td>
        ${passed
          ? `<span style="color:var(--success);font-weight:700">LOCKED</span>`
          : `<button class="btn-primary" onclick="save(${o.index})">Save</button>`
        }
      </td>`;
    tb.appendChild(tr);
  });
}

function save(rowIndex){
  const inp=document.getElementById("p_"+rowIndex);
  const val=inp.value;
  if(val==="" || Number(val)<0){alert("Enter valid amount");return;}

  showLoader(true);
  const cb="save_"+Date.now(); let s;
  window[cb]=()=>{
    showLoader(false); loadRows();
    delete window[cb]; s.remove();
  };
  s=document.createElement("script");
  s.src=`${API_URL}?action=savePassedAmount&rowIndex=${rowIndex}&amount=${encodeURIComponent(val)}&callback=${cb}`;
  document.body.appendChild(s);
}

function fmt(v){const d=new Date(v);return isNaN(d)?"":d.toLocaleDateString("en-GB");}
function goHome(){location.href="index.html";}
</script>

</body>
</html>
