<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mark Passed Amount</title>

<style>
:root {
  --primary:#1d4ed8; --bg:#eef2f7; --card:#fff; --border:#cbd5e1;
  --text:#111827; --muted:#6b7280; --danger:#b91c1c; --success:#15803d;
}
body{font-family:system-ui,Segoe UI,Arial;font-size:13px;background:var(--bg);padding:20px;color:var(--text)}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:var(--card);
  border:2px solid var(--border);border-radius:8px;padding:14px 18px;margin-bottom:16px}
h1{margin:0;font-size:18px}
.card{background:var(--card);border:2px solid var(--border);border-radius:8px;padding:16px}
table{width:100%;border-collapse:separate;border-spacing:0;border:2px solid var(--border);border-radius:8px;overflow:hidden}
th{background:#e2e8f0;padding:10px;font-size:12px}
td{padding:9px;border-bottom:1px solid var(--border);text-align:center}
tbody tr:nth-child(even){background:#f8fafc}
input[type=number]{width:110px;padding:6px;border:2px solid var(--border);border-radius:4px}
input[disabled]{background:#f3f4f6;color:#6b7280}
button{padding:7px 14px;border-radius:4px;border:none;font-weight:600;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca}
.loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);align-items:center;justify-content:center;z-index:9999}
.spinner{width:42px;height:42px;border:4px solid #cbd5e1;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:10000}
.modal-box{background:#fff;padding:20px;border-radius:6px;text-align:center;min-width:260px}
</style>
</head>

<body>

<div id="loader" class="loader"><div class="spinner"></div></div>

<div id="modal" class="modal">
  <div class="modal-box">
    <div id="modalText"></div><br>
    <button class="btn-primary" onclick="closeModal()">OK</button>
  </div>
</div>

<div class="top-bar">
  <h1 id="title"></h1>
  <div>
    <button class="btn-primary" onclick="saveAll()">Save Passed Amounts</button>
    <button onclick="goHome()">⬅ Back</button>
  </div>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Engineer</th>
        <th>Machine No</th>
        <th>TA+DA</th>
        <th>Passed Amount</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";
const LIST_ID=new URLSearchParams(location.search).get("listId");
document.getElementById("title").textContent="Mark Passed : "+LIST_ID;

let rowMap=[];

showLoader(true);
loadRows();

function showLoader(s){document.getElementById("loader").style.display=s?"flex":"none";}
function showModal(t){document.getElementById("modalText").innerText=t;document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}

function loadRows(){
  const cb="rows_"+Date.now(); let s;
  window[cb]=items=>{
    render(items); showLoader(false);
    delete window[cb]; s.remove();
  };
  s=document.createElement("script");
  s.src=`${API_URL}?action=getListRows&listId=${LIST_ID}&callback=${cb}`;
  document.body.appendChild(s);
}

function render(items){
  const tb=document.getElementById("tbody"); tb.innerHTML="";
  rowMap=[];
  items.forEach(o=>{
    const r=o.row;
    const passed=r[31]; // AF
    rowMap.push({rowIndex:o.index, passed});

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${fmt(r[28])}</td>
      <td>${r[3]}</td>
      <td>${r[10]}</td>
      <td>${r[27]}</td>
      <td>
        <input type="number" min="0" step="0.01"
          id="p_${o.index}"
          value="${passed ?? ""}"
          ${passed!=="" && passed!==null ? "disabled" : ""}>
      </td>
      <td>${passed!=="" && passed!==null ? "PASSED" : "PENDING"}</td>
    `;
    tb.appendChild(tr);
  });
}

function saveAll(){
  const payload=[];
    for (const r of rowMap) {
      const inp = document.getElementById("p_" + r.rowIndex);
    
      // locked row → OK
      if (inp.disabled) continue;
    
      // blank is NOT allowed
      if (inp.value === "") {
        showModal("❌ All rows must have Passed Amount (0 allowed)");
        return;
      }
    
      payload.push({
        rowIndex: r.rowIndex,
        amount: inp.value
      });
    }


  if(!payload.length){
    showModal("Nothing to save");
    return;
  }

  showLoader(true);
  const cb="save_"+Date.now(); let s;
  window[cb]=()=>{
    showLoader(false);
    showModal("✅ Passed Amounts saved successfully");
    loadRows();
    delete window[cb]; s.remove();
  };
  s=document.createElement("script");
  s.src=`${API_URL}?action=savePassedList&listId=${LIST_ID}&data=${encodeURIComponent(JSON.stringify(payload))}&callback=${cb}`;
  document.body.appendChild(s);
}

function fmt(v){const d=new Date(v);return isNaN(d)?"":d.toLocaleDateString("en-GB");}
function goHome(){location.href="index.html";}
</script>

</body>
</html>
