<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TA/DA Dashboard</title>

<style>
body{
  font-family:system-ui,Arial;
  background:#eef2f7;
  padding:20px;
  font-size:13px
}

.top{
  background:#fff;
  border:2px solid #cbd5e1;
  border-radius:8px;
  padding:14px;
  margin-bottom:16px
}

.filters{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap
}

input{
  padding:7px;
  border:2px solid #cbd5e1;
  border-radius:4px
}

button{
  padding:7px 14px;
  border:none;
  border-radius:4px;
  background:#1d4ed8;
  color:#fff;
  font-weight:600;
  cursor:pointer
}

.cards{
  display:flex;
  gap:14px;
  margin-bottom:16px
}

.card{
  flex:1;
  background:#fff;
  border:2px solid #cbd5e1;
  border-radius:8px;
  padding:14px;
  text-align:center
}

.card h3{
  margin:0;
  font-size:12px;
  color:#6b7280
}

.card div{
  font-size:20px;
  font-weight:700;
  margin-top:6px
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

th{
  background:#f3f4f6;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.4px;
  font-weight:700;
  padding:12px;
}

td{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #e5e7eb;
}

tbody tr:hover{
  background:#eef2ff;
  transition:.15s ease;
}

.details{
  margin-top:16px;
  display:none
}

/* ===== LOADER ===== */
#loader{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  z-index:9999;
  align-items:center;
  justify-content:center
}

.spinner{
  width:42px;
  height:42px;
  border:4px solid #cbd5e1;
  border-top-color:#1d4ed8;
  border-radius:50%;
  animation:spin 1s linear infinite
}



.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(135deg,#1d4ed8,#2563eb);
  color:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 15px 35px rgba(0,0,0,.15);
}

.header h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}

.header p{
  margin:4px 0 0;
  font-size:13px;
  opacity:.9;
}

.btn-light{
  background:#fff;
  color:#1d4ed8;
  font-weight:700;
  border-radius:8px;
}


.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:18px;
  margin-bottom:22px;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  text-align:left;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  transition:.25s ease;
  border:none;
}

.card:hover{
  transform:translateY(-4px);
  box-shadow:0 15px 35px rgba(0,0,0,.15);
}

.card h3{
  font-size:12px;
  color:#6b7280;
  margin:0;
  text-transform:uppercase;
  letter-spacing:.5px;
}

.card div{
  font-size:26px;
  font-weight:800;
  margin-top:8px;
}

  
  
.status-badge{
  padding:4px 8px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
}

.status-badge.VERIFIED{
  background:#dcfce7;
  color:#15803d;
}

.status-badge.PASSED{
  background:#ede9fe;
  color:#6d28d9;
}


.details{
  margin-top:20px;
  display:none;
  animation:fadeIn .3s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}


  


  
@keyframes spin{
  to{transform:rotate(360deg)}
}
</style>
</head>

<body>

<div id="loader"><div class="spinner"></div></div>

<!-- ===== HEADER ===== -->
<div class="header">
  <div>
    <h1>TA / DA Reporting Dashboard</h1>
    <p>Verified & Passed Bills Overview</p>
  </div>

  <button class="btn-light" onclick="goBack()">⬅ Back</button>
</div>


<!-- ===== FILTERS ===== -->
<div class="top">
  <div class="filters">
    From <input type="date" id="from">
    To <input type="date" id="to">
    Machine <input type="text" id="machine" placeholder="Machine No">

    Engineer
    <input
      type="text"
      id="engFilter"
      placeholder="Engineer name"
      list="engineerList"
    >
    <datalist id="engineerList"></datalist>

    <button onclick="load()">Apply</button>
  </div>
</div>

<!-- ===== SUMMARY CARDS ===== -->
<div class="card" style="border-left:6px solid #1d4ed8">
  <h3>Total Calls</h3>
  <div id="c1">0</div>
</div>

<div class="card" style="border-left:6px solid #f59e0b">
  <h3>Total TA+DA</h3>
  <div id="c2">₹0</div>
</div>

<div class="card" style="border-left:6px solid #16a34a">
  <h3>Total Passed</h3>
  <div id="c3">₹0</div>
</div>


<!-- ===== ENGINEER SUMMARY ===== -->
<table id="summary">
<thead>
<tr>
  <th>Engineer</th>
  <th>Calls</th>
  <th>Total TA+DA</th>
  <th>Total Passed</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- ===== ENGINEER DETAILS ===== -->
<div class="details" id="details">
  <h3 id="dTitle"></h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Machine No</th>
        <th>Customer</th>
        <th>Complaint</th>
        <th>Call Type</th>
        <th>Site Location</th>
        <th>Call ID</th>
        <th>Distance</th>
        <th>SVR No</th>
        <th>List ID</th>
        <th>Status</th>
        <th>TA+DA</th>
        <th>Passed</th>
      </tr>
      </thead>

    <tbody id="detailBody"></tbody>
  </table>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const fromEl = document.getElementById("from");
const toEl = document.getElementById("to");
const machineEl = document.getElementById("machine");
const engFilterEl = document.getElementById("engFilter");
const engineerListEl = document.getElementById("engineerList");

let cachedRows = [];

/* ===== DEFAULT DATES + AUTO LOAD ===== */
(function init(){
  fromEl.value = "2025-12-01";
  toEl.value = new Date().toISOString().split("T")[0];
  load();
})();

function showLoader(show){
  document.getElementById("loader").style.display =
    show ? "flex" : "none";
}

function load(){
  showLoader(true);

  const cb="dash_"+Date.now();
  let s;

  window[cb]=data=>{
    render(data);
    showLoader(false);
    delete window[cb];
    s.remove();
  };

  s=document.createElement("script");
  s.src=
    `${API_URL}?action=getDashboardData` +
    `&from=${fromEl.value}` +
    `&to=${toEl.value}` +
    `&machine=${machineEl.value}` +
    `&callback=${cb}`;

  document.body.appendChild(s);
}

function render(d){
  c1.textContent=d.totals.calls;
  c2.textContent="₹"+d.totals.tada.toLocaleString();
  c3.textContent="₹"+d.totals.passed.toLocaleString();

  cachedRows=d.rows;

  populateEngineerList(d.engineers);
  renderSummary(d.engineers);
}

function populateEngineerList(engineers){
  engineerListEl.innerHTML="";
  engineers.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e.engineer;
    engineerListEl.appendChild(opt);
  });
}

function renderSummary(engineers){
  const filter = engFilterEl.value.trim().toUpperCase();
  const tb=document.querySelector("#summary tbody");
  tb.innerHTML="";
  details.style.display="none";

  engineers
    .filter(e=>!filter || e.engineer.includes(filter))
    .forEach(e=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td style="cursor:pointer;color:#1d4ed8;font-weight:600"
            onclick="showDetails('${e.engineer}')">
          ${e.engineer}
        </td>
        <td>${e.calls}</td>
        <td>₹${e.tada.toLocaleString()}</td>
        <td>₹${e.passed.toLocaleString()}</td>
      `;
      tb.appendChild(tr);
    });
}

function showDetails(engineer){
  details.style.display = "block";
  dTitle.textContent = "Engineer: " + engineer;
  detailBody.innerHTML = "";

  cachedRows
    .filter(r => r.engineer === engineer)
    .forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.date || ""}</td>
        <td>${r.machine || ""}</td>
        <td>${r.customer || ""}</td>
        <td>${r.complaint || ""}</td>
        <td>${r.callType || ""}</td>
        <td>${r.siteLocation || ""}</td>
        <td>${r.callId || ""}</td>
        <td>${r.distance || ""}</td>
        <td>${r.svrNo || ""}</td>
        <td>${r.listId || ""}</td>
        <td>
          <span class="status-badge ${r.status}">
            ${r.status || ""}
          </span>
        </td>

        <td>${r.tada || ""}</td>
        <td>${r.passed || ""}</td>
      `;

      detailBody.appendChild(tr);
    });
}


function goBack(){
  window.location.href="index.html";
}
</script>

</body>
</html>
