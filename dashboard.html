<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TA/DA Dashboard</title>

<style>

/* ===== DESIGN TOKENS (Same as Index) ===== */
:root {
  --yellow: #facc15;
  --yellow-dark: #eab308;
  --black: #0f0f0f;
  --bg: #eef2f7;
  --card: #ffffff;
  --border: #cbd5e1;
  --text: #111827;
  --muted: #6b7280;
  --primary: #1d4ed8;
}

body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  padding:20px;
  font-size:13px;
  color: var(--text);
}

/* ===== TOP BAR (MATCH INDEX) ===== */
.top-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--black);
  border-radius:10px;
  padding:16px 22px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.35);
}

.app-title h1{
  margin:0;
  font-size:20px;
  font-weight:800;
  color:var(--yellow);
}

.app-subtitle{
  margin-top:2px;
  font-size:12px;
  color:#e5e7eb;
}

.btn-secondary{
  padding:8px 14px;
  font-size:13px;
  font-weight:700;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#1f2933;
  color:#fff;
}

.btn-secondary:hover{
  background:#374151;
}

/* ===== FILTER CARD (Match Index Card Style) ===== */
.top{
  background:linear-gradient(
    180deg,
    #ffffff 0%,
    #f9fafb 100%
  );
  border:2px solid #e5e7eb;
  border-radius:10px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.filters{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

input{
  padding:7px;
  border:2px solid var(--border);
  border-radius:6px;
}

button{
  padding:7px 14px;
  border:none;
  border-radius:6px;
  background:var(--yellow);
  color:#111;
  font-weight:700;
  cursor:pointer;
}

button:hover{
  background:var(--yellow-dark);
}

/* ===== SUMMARY CARDS (SIDE BY SIDE) ===== */
.cards{
  display:flex;
  gap:14px;
  margin-bottom:20px;
}

.card{
  flex:1;
  background:linear-gradient(
    180deg,
    #ffffff 0%,
    #f9fafb 100%
  );
  border:2px solid #e5e7eb;
  border-radius:10px;
  padding:18px;
  text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  transition:.2s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 22px rgba(0,0,0,0.12);
}

.card h3{
  margin:0;
  font-size:12px;
  font-weight:800;
  color:#6b7280;
  text-transform:uppercase;
}

.card div{
  font-size:22px;
  font-weight:800;
  margin-top:6px;
}

/* ===== TABLE (Match Index Style) ===== */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border:2px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  background:#fff;
}

/* Header centered */
th{
  background:linear-gradient(
    180deg,
    #facc15 0%,
    #fde047 100%
  );
  color:#111;
  font-size:12px;
  font-weight:800;
  padding:10px;
  border-bottom:2px solid #eab308;
  text-align:center;
}

thead th{
  position:sticky;
  top:0;
  z-index:5;
  box-shadow:0 2px 4px rgba(0,0,0,0.08);
}



  
/* Body left aligned */
td{
  padding:9px;
  font-size:12px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

tbody tr:nth-child(even){
  background:#f8fafc;
}

tbody tr:hover{
  background:#e0f2fe;
}


/* Yellow left border for engineer summary rows */
#summary tbody tr{
  border-left:5px solid var(--yellow);
}

#summary tbody tr:hover{
  background:#fffbea;
}


  
/* ===== STATUS BADGES (Keep Yours) ===== */
.status-badge{
  padding:4px 8px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
}

.status-badge.VERIFIED{
  background:#dcfce7;
  color:#15803d;
}

.status-badge.PASSED{
  background:#ede9fe;
  color:#6d28d9;
}

/* ===== DETAILS ANIMATION (Keep Yours) ===== */
.details{
  margin-top:20px;
  display:none;
  animation:fadeIn .3s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* ===== LOADER (UNCHANGED) ===== */
#loader{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  z-index:9999;
  align-items:center;
  justify-content:center;
}

.spinner{
  width:42px;
  height:42px;
  border:4px solid #cbd5e1;
  border-top-color:var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

</style>

</head>

<body>

<div id="loader"><div class="spinner"></div></div>

<!-- ===== HEADER ===== -->
<div class="top-bar">
  <div class="top-left">
    <div class="app-title">
      <h1>TA / DA DASHBOARD</h1>
      <div class="app-subtitle">
        Verified & Passed Bills Overview
      </div>
    </div>
  </div>

  <div>
    <button class="btn-secondary" onclick="goBack()">
      ⬅ Back
    </button>
  </div>
</div>


<!-- ===== FILTERS ===== -->
<div class="top">
  <div class="filters">
    From <input type="date" id="from">
    To <input type="date" id="to">
    Machine <input type="text" id="machine" placeholder="Machine No">

    Engineer
    <input
      type="text"
      id="engFilter"
      placeholder="Engineer name"
      list="engineerList"
    >
    <datalist id="engineerList"></datalist>

    <button onclick="load()">Apply</button>
  </div>
</div>

<!-- ===== SUMMARY CARDS ===== -->
<div class="cards">
  <div class="card" style="border-left:6px solid #1d4ed8">
    <h3>Total Calls</h3>
    <div id="c1">0</div>
  </div>

  <div class="card" style="border-left:6px solid #f59e0b">
    <h3>Total TA+DA</h3>
    <div id="c2">₹0</div>
  </div>

  <div class="card" style="border-left:6px solid #16a34a">
    <h3>Total Passed</h3>
    <div id="c3">₹0</div>
  </div>
</div>



<!-- ===== ENGINEER SUMMARY ===== -->
<table id="summary">
<thead>
<tr>
  <th>Engineer</th>
  <th>Calls</th>
  <th>Total TA+DA</th>
  <th>Total Passed</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- ===== ENGINEER DETAILS ===== -->
<div class="details" id="details">
  <h3 id="dTitle"></h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Machine No</th>
        <th>Customer</th>
        <th>Complaint</th>
        <th>Call Type</th>
        <th>Site Location</th>
        <th>Call ID</th>
        <th>Labour</th>
        <th>SVR No</th>
        <th>List ID</th>
        <th>Status</th>
        <th>TA+DA</th>
        <th>Passed</th>
      </tr>
      </thead>

    <tbody id="detailBody"></tbody>
  </table>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const fromEl = document.getElementById("from");
const toEl = document.getElementById("to");
const machineEl = document.getElementById("machine");
const engFilterEl = document.getElementById("engFilter");
const engineerListEl = document.getElementById("engineerList");

let cachedRows = [];

let currentView = "locations";
let cachedLocations = [];
let cachedEngineers = [];

  
/* ===== DEFAULT DATES + AUTO LOAD ===== */
(function init(){
  fromEl.value = "2025-12-01";
  toEl.value = new Date().toISOString().split("T")[0];
  load();
})();

function showLoader(show){
  document.getElementById("loader").style.display =
    show ? "flex" : "none";
}

function load(){
  showLoader(true);

  const cb="dash_"+Date.now();
  let s;

  window[cb]=data=>{
    render(data);
    showLoader(false);
    delete window[cb];
    s.remove();
  };

  s=document.createElement("script");
  s.src=
    `${API_URL}?action=getDashboardData` +
    `&from=${fromEl.value}` +
    `&to=${toEl.value}` +
    `&machine=${machineEl.value}` +
    `&callback=${cb}`;

  document.body.appendChild(s);
}

function render(d){
  c1.textContent=d.totals.calls;
  c2.textContent="₹"+Math.round(d.totals.tada).toLocaleString();
  c3.textContent="₹"+Math.round(d.totals.passed).toLocaleString();


  cachedRows=d.rows;
  cachedLocations=d.locations;
  cachedEngineers=d.engineers;

  renderLocations();
}


function renderLocations(){

  currentView="locations";
  const tb=document.querySelector("#summary tbody");
  tb.innerHTML="";
  details.style.display="none";

  document.querySelector("#summary thead tr").innerHTML=`
    <th>Location</th>
    <th>Engineers</th>
    <th>Calls</th>
    <th>Total TA+DA</th>
    <th>Total Passed</th>
  `;

  cachedLocations.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td style="cursor:pointer;color:#1d4ed8;font-weight:700"
          onclick="renderEngineers('${l.location}')">
        ${l.location}
      </td>
      <td>${l.engineerCount}</td>
      <td>${l.calls}</td>
      <td>₹${Math.round(l.tada).toLocaleString()}</td>
      <td>₹${Math.round(l.passed).toLocaleString()}</td>

    `;
    tb.appendChild(tr);
  });
}


function renderEngineers(location){

  currentView="engineers";

  const tb=document.querySelector("#summary tbody");
  tb.innerHTML="";
  details.style.display="none";

  document.querySelector("#summary thead tr").innerHTML=`
    <th>Engineer</th>
    <th>Calls</th>
    <th>Total TA+DA</th>
    <th>Total Passed</th>
  `;

  const filtered = cachedEngineers.filter(e=>e.location===location);

  filtered.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td style="cursor:pointer;color:#1d4ed8;font-weight:600"
          onclick="showDetails('${e.engineer}')">
        ${e.engineer}
      </td>
      <td>${e.calls}</td>
      <td>₹${Math.round(e.tada).toLocaleString()}</td>
      <td>₹${Math.round(e.passed).toLocaleString()}</td>

    `;
    tb.appendChild(tr);
  });

  addBackButton();
}



function addBackButton(){

  const header=document.querySelector(".top-bar");

  if(document.getElementById("locBack")) return;

  const btn=document.createElement("button");
  btn.id="locBack";
  btn.className="btn-secondary";
  btn.innerHTML="⬅ Back to Locations";
  btn.style.marginRight="10px";

  btn.onclick=function(){
    this.remove();
    renderLocations();
  };

  header.appendChild(btn);
}

  
  
  

function populateEngineerList(engineers){
  engineerListEl.innerHTML="";
  engineers.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e.engineer;
    engineerListEl.appendChild(opt);
  });
}

function renderSummary(engineers){
  const filter = engFilterEl.value.trim().toUpperCase();
  const tb=document.querySelector("#summary tbody");
  tb.innerHTML="";
  details.style.display="none";

  engineers
    .filter(e=>!filter || e.engineer.includes(filter))
    .forEach(e=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td style="cursor:pointer;color:#1d4ed8;font-weight:600"
            onclick="showDetails('${e.engineer}')">
          ${e.engineer}
        </td>
        <td>${e.calls}</td>
        <td>₹${e.tada.toLocaleString()}</td>
        <td>₹${e.passed.toLocaleString()}</td>
      `;
      tb.appendChild(tr);
    });
}

function showDetails(engineer){
  details.style.display = "block";
  dTitle.textContent = "Engineer: " + engineer;
  detailBody.innerHTML = "";

  cachedRows
    .filter(r => r.engineer === engineer)
    .forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.date || ""}</td>
        <td>${r.machine || ""}</td>
        <td>${r.customer || ""}</td>
        <td>${r.complaint || ""}</td>
        <td>${r.callType || ""}</td>
        <td>${r.siteLocation || ""}</td>
        <td>${r.callId || ""}</td>
        <td>${r.distance || ""}</td>
        <td>${r.svrNo || ""}</td>
        <td>${r.listId || ""}</td>
        <td>
          <span class="status-badge ${r.status}">
            ${r.status || ""}
          </span>
        </td>
        
        <td>${r.tada ? Math.round(r.tada).toLocaleString() : ""}</td>
        <td>${r.passed ? Math.round(r.passed).toLocaleString() : ""}</td>

      `;

      detailBody.appendChild(tr);
    });
}


function goBack(){
  window.location.href="index.html";
}
</script>

</body>
</html>
