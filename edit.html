<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit SVR List</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }
    th { background: #f3f3f3; position: sticky; top: 0; }
    button { padding: 6px 10px; }
  </style>
</head>

<body>

<h2 id="title"></h2>
<button onclick="goHome()">â¬… Back to Home</button>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Location</th>
  <th>Engineer</th>
  <th>WS/OS</th>
  <th>Call Type</th>
  <th>Complaint</th>
  <th>Customer</th>
  <th>Machine No</th>
  <th>HMR</th>
  <th>Status</th>
  <th>Site Location</th>
  <th>Call ID</th>
  <th>Labour</th>
  <th>Distance</th>
  <th>TA+DA</th>
  <th>SVR No</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const API_URL =
  "https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const params = new URLSearchParams(window.location.search);
const LIST_ID = params.get("listId");

document.getElementById("title").textContent =
  "Editing List : " + LIST_ID;

loadRows();

function loadRows() {
  const cb = "rows_cb_" + Date.now();
  let script;

  window[cb] = function (items) {
    render(items);
    delete window[cb];
    script.remove();
  };

  script = document.createElement("script");
  script.src =
    `${API_URL}?action=getListRows&listId=${LIST_ID}&callback=${cb}`;
  document.body.appendChild(script);
}

function render(items) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  if (!items.length) {
    tbody.innerHTML =
      "<tr><td colspan='17'>No rows found</td></tr>";
    return;
  }

  items.forEach(o => {
    const r = o.row;
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${fmt(r[28])}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td>${r[6]}</td>
      <td>${r[7]}</td>
      <td>${r[10]}</td>
      <td>${r[11]}</td>
      <td>${r[12]}</td>
      <td>${r[14]}</td>
      <td>${r[19]}</td>
      <td>${r[21]}</td>
      <td>${r[22]}</td>
      <td>${r[25]}</td>
      <td>${r[1]}</td>
      <td>
        <button onclick="del(${o.index})">Delete</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function fmt(v) {
  const d = new Date(v);
  return isNaN(d) ? "" : d.toLocaleDateString("en-GB");
}

function del(rowIndex) {
  if (!confirm("Delete this row permanently?")) return;

  const cb = "del_cb_" + Date.now();
  let script;

  window[cb] = () => loadRows();

  script = document.createElement("script");
  script.src =
    `${API_URL}?action=deleteRow&rowIndex=${rowIndex}&callback=${cb}`;
  document.body.appendChild(script);
}

function goHome() {
  window.location.href = "home.html";
}
</script>

</body>
</html>
