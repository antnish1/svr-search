<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Edit SVR List</title>

<style>
:root {
  --primary: #1d4ed8;
  --primary-dark: #1e40af;
  --bg: #eef2f7;
  --card: #ffffff;
  --border: #cbd5e1;
  --text: #111827;
  --muted: #4b5563;
  --danger: #b91c1c;
}

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 13px;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 14px 18px;
  margin-bottom: 18px;
}

.page-title h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
}

.page-title span {
  font-size: 12px;
  color: var(--muted);
}

button {
  padding: 7px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 4px;
  border: none;
  cursor: pointer;
}

.btn-primary {
  background: var(--primary);
  color: #fff;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-danger {
  background: #fee2e2;
  color: var(--danger);
  border: 1px solid #fecaca;
}

.btn-danger:hover {
  background: #fecaca;
}

.card {
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 2px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  background: var(--card);
}

th {
  background: #e2e8f0;
  font-size: 12px;
  font-weight: 700;
  padding: 10px;
  border-bottom: 2px solid var(--border);
  position: sticky;
  top: 0;
}

td {
  padding: 9px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  text-align: center;
}

tbody tr:nth-child(even) {
  background: #f8fafc;
}

tbody tr:hover {
  background: #e0f2fe;
}

.loader-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,.85);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.spinner {
  width: 42px;
  height: 42px;
  border: 4px solid #cbd5e1;
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.show {
  display: flex;
}

.modal-box {
  background: white;
  border-radius: 8px;
  padding: 20px;
  min-width: 280px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
}
</style>
</head>

<body>

<!-- LOADER -->
<div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="modal-overlay">
  <div class="modal-box">
    <div id="confirmText" style="margin-bottom:15px;font-weight:600"></div>
    <button class="btn-danger" onclick="confirmDelete()">Yes, Delete</button>
    <button onclick="closeConfirm()">Cancel</button>
  </div>
</div>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="page-title">
    <h1 id="title"></h1>
    <span>Edit & manage list entries</span>
  </div>

  <button class="btn-primary" onclick="goHome()">â¬… Back to Home</button>
</div>

<!-- CONTENT -->
<div class="card">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Location</th>
        <th>Engineer</th>
        <th>WS/OS</th>
        <th>Call Type</th>
        <th>Complaint</th>
        <th>Customer</th>
        <th>Machine No</th>
        <th>HMR</th>
        <th>Status</th>
        <th>Site Location</th>
        <th>Call ID</th>
        <th>Labour</th>
        <th>Distance</th>
        <th>TA+DA</th>
        <th>Invoice</th>
        <th>SVR No</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwDNZYXD4OkYwOvJ6NoqEsVSZGzyj4_euck_ZGz61Cd5GjKfVfbww8Fyk8t5N-zrJA/exec";

const params = new URLSearchParams(window.location.search);
const LIST_ID = params.get("listId");

let deletePayload = null;

document.getElementById("title").textContent =
  "Editing List : " + LIST_ID;

showLoader(true);
loadRows();

function showLoader(s) {
  document.getElementById("loader").style.display = s ? "flex" : "none";
}

function loadRows() {
  const cb = "rows_cb_" + Date.now();
  let script;

  window[cb] = function (items) {
    render(items);
    showLoader(false);
    delete window[cb];
    script.remove();
  };

  script = document.createElement("script");
  script.src =
    `${API_URL}?action=getListRows&listId=${LIST_ID}&callback=${cb}`;
  document.body.appendChild(script);
}

function render(items) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  if (!items.length) {
    tbody.innerHTML =
      "<tr><td colspan='18'>No rows found</td></tr>";
    return;
  }

  items.forEach(o => {
    const r = o.row;
    const invoice = r[30] || "";
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${fmt(r[28])}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td>${r[6]}</td>
      <td>${r[7]}</td>
      <td>${r[10]}</td>
      <td>${r[11]}</td>
      <td>${r[12]}</td>
      <td>${r[15]}</td>
      <td>${r[21]}</td>
      <td>${r[22]}</td>
      <td>${r[23]}</td>
      <td>${r[27]}</td>
      <td>${invoice}</td>
      <td>${r[1]}</td>
      <td>
        <button class="btn-danger" onclick="askDelete(
          '${r[28]}',
          '${r[3]}',
          '${r[10]}'
        )">
          Delete
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function askDelete(date, engineer, machine) {
  deletePayload = { date, engineer, machine };
  document.getElementById("confirmText").innerText =
    "Delete this row permanently?";
  document.getElementById("confirmModal").classList.add("show");
}

function closeConfirm() {
  document.getElementById("confirmModal").classList.remove("show");
  deletePayload = null;
}

function confirmDelete() {
  if (!deletePayload) return;

  closeConfirm();
  showLoader(true);

  const cb = "del_cb_" + Date.now();
  let script;

  window[cb] = () => {
    loadRows();
    delete window[cb];
    script.remove();
  };

  script = document.createElement("script");
  script.src =
    `${API_URL}?action=deleteRowByKey` +
    `&listId=${encodeURIComponent(LIST_ID)}` +
    `&date=${encodeURIComponent(deletePayload.date)}` +
    `&engineer=${encodeURIComponent(deletePayload.engineer)}` +
    `&machine=${encodeURIComponent(deletePayload.machine)}` +
    `&callback=${cb}`;

  document.body.appendChild(script);
}

function fmt(v) {
  const d = new Date(v);
  return isNaN(d) ? "" : d.toLocaleDateString("en-GB");
}

function goHome() {
  window.location.href = "index.html";
}
</script>

</body>
</html>
